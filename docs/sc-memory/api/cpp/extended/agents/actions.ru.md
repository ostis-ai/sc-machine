# **C++ Actions API**

!!! примечание
    Это верно только для версий sc-machine >= 0.10.0.
--- 

**C++ Actions API** предназначен для определения и инициирования действий, которые агенты могут выполнять в среде sc-machine. В этом разделе представлены рекомендации по реализации различных действий, включая их аргументы и результаты.

!!! примечание
    Чтобы подключить этот API, укажите #include <sc-memory/sc_action.hpp> в исходном файле hpp.

## **Что такое действие?**

Все действия – это процессы. Любой процесс совершается каким-то субъектом. Каждое действие можно определить как процесс решения некоторой проблемы, т. е. как процесс достижения заданной цели с заданными условиями. Каждое действие обозначает некоторое преобразование, осуществляемое во внешней среде или в памяти некоторой системы.

Как и агент, действие имеет спецификацию. Эта спецификация включает в себя: класс, аргументы, состояние, результат. Спецификация действия называется проблемой.

## **ScAction**

Sc-машина предоставляет класс `ScAction` для обработки действий в sc-памяти. Вы не можете использовать конструкторы этого класса, поскольку они являются закрытыми(private). Используйте `ScAgentContext` для создания действия с предоставленным классом или используйте существующий. Все методы этого класса работают напрямую с базой знаний, локального кеша нет.

```cpp
// Находим класс действия и генерируем действие.
...
ScAction action = context.GenerateAction(actionClassAddr);
...
```

<scg src="../images/actions/action_class.gwf"></scg>

!!! примечание
    Вы должны предоставить класс действия, который относится к одному из типов: `receptor_action`, `effector_action`, `behavioral_action` или `information_action`.
    
```cpp
// Или найти действие и преобразовать его в объект класса `ScAction`.
...
ScAction action = context.ConvertToAction(actionAddr);
...
```

### **GetClass**

Чтобы получить класс действия, используйте этот метод.

```cpp
...
ScAddr const & actionClassAddr = action.GetClass();
...
```

### **GetArgument**

Действия могут иметь аргументы. Аргументы действия — это некоторые объекты, с помощью которых это действие должно быть выполнено. Если у действия есть аргументы в базе знаний, вы их получите. Для этого есть пара геттеров.

```cpp
...
// Укажите здесь отношение, если ваш аргумент играет определенную роль в действии. 
ScAddr const & argAddr = action.GetArgument(ScKeynodes::rrel_1);
// Если аргумента с такой ролью нет, то `argAddr` будет пустым.
...
```

```cpp
...
// Или укажите индекс аргумента. 1 равно `ScKeynodes::rrel_1`,
// 2 равно `ScKeynodes::rrel_2` и т.д.
ScAddr const & argAddr = action.GetArgument(1);
// Если аргумента с такой ролью нет, то `argAddr` будет пустым.
...
```

<scg src="../images/actions/action_argument.gwf"></scg>

!!! примечание
    Существует ограничение на количество ролевых отношений порядка. Вы можете получить от `rrel_1` до `rrel_20` включительно.

!!! предупреждение
    Этот метод выдаст `utils::ExceptionInvalidParams`, если вы укажете неверный индекс для аргумента (например, 0 или 21).

```cpp
...
ScAddr const & argAddr = action.GetArgument(1, defaultArgumentAddr);
// Если аргумента с такой ролью нет, то `argAddr` будет равен 
// `defaultArgumentAddr`.
...
```

### **GetArguments**

Вы можете получить все аргументы, используя один метод получения(геттер).

```cpp
...
// Здесь 2 — количество аргументов в указанном действии.
auto const & [argAddr1, argAddr2] = action.GetArguments<2>();
// Если у действия нет аргумента, оно будет пустым.
...
```

```cpp
...
// Вы можете игнорировать некоторые аргументы.
auto const & [argAddr1, argAddr2, _] = action.GetArguments<3>();
...
```

<scg src="../images/actions/action_arguments.gwf"></scg>

### **SetArgument**

Вы можете установить аргументы для указанного действия.

```cpp
...
// Укажите здесь отношение, если ваш аргумент должен играть определенную роль в действии.
action.SetArgument(ScKeynodes::rrel_1, argAddr);
...
```

```cpp
...
// Или укажите индекс аргумента. 1 равно `ScKeynodes::rrel_1`,
// 2 равно `ScKeynodes::rrel_2` и т. д.
action.SetArgument(1, argAddr);
...
```

<scg src="../images/actions/action_argument.gwf"></scg>

!!! примечание
    Если у действия уже есть аргумент с указанной ролью, то связь между действием и существующим аргументом будет удалена и будет создана связь между действием и новым аргументом.

### **SetArguments**

```cpp
...
// Установка нескольких аргументов одновременно.
action.SetArguments(argAddr1, argAddr2);
...
```

<scg src="../images/actions/action_arguments.gwf"></scg>

### **Action result**

Все действия должны иметь результат (результатную ситуацию). Результатная ситуация – структура, содержащая все sc-конструкции, обозначающие результат выполненного (законченного) действия.

#### **GetResult**

Вы можете получить результат любого действия. Результат может быть пустым.

```cpp
...
// Используйте этот метод после того, как какой-либо агент завершит выполнение действия.

ScStructure const & actionResult = action.GetResult();
...
```

<scg src="../images/actions/action_result.gwf"></scg>

!!! предупреждение
    Если вы вызываете этот метод для незавершенного действия, то этот метод выдаст `utils::ExceptionInvalidState`. Это предотвращает ситуацию, когда агент, выполняющий действие, еще формирует результат для этого действия, а вы не дождались его и уже хотите получить результат для этого действия.

#### **SetResult**

```cpp
...
// Используйте этот метод при выполнении действия агентом 
// чтобы установить новый результат.
action.SetResult(resultStructure);
...
```

!!! примечание
    Если действие имеет результат, то существующий результат будет удален и установлен новый.

!!! предупреждение
    Если вы вызовете этот метод для не завершённого, но инициированного действия, то этот метод вызовет исключение `utils::ExceptionInvalidState`.

#### **FormResult**

Вы не можете генерировать структуру результатов. Вы можете предоставить только элементы результата для действия.

```cpp
...
// Используйте этот метод при выполнении действия агентом 
// для формирования нового результата с предоставленными sc-элементами.
action.FormResult(elementAddr1, elementAddr2);
...
```

!!! примечание
    Если действие имеет результат, то существующий результат будет удален и установлен новый.

#### **UpdateResult**

```cpp
...
// Используйте этот метод при выполнении действия агентом
// для обновления существующего результата новыми sc-элементами.
action.UpdateResult(elementAddr1, elementAddr2);
...
```

!!! примечание
    Этот метод обновляет существующий результат для действия.

!!! примечание
    `FormResult` и `UpdateResult` не добавляют sc-элемент дважды.

!!! примечание
    Если вы не сформируете результат, то при завершении действия будет сгенерирован пустой результат для вашего действия.

### **Action states**

Все действия имеют состояние. Этот API предоставляет три состояния действий:

* действие не инициировано;
* действие инициировано, но не завершено (т. е. действие выполняется);
* действие завершено.

Вы можете инициировать, ждать или завершать действия.

#### **IsInitiated**

Use this method to check that specified action is initiated.

```cpp
...
bool const isActionInitiated = action.IsInitiated();
...
```

<scg src="../images/actions/is_action_initiated.gwf"></scg>

#### **InitiateAndWait**

Вы можете инициировать действие и ждать его завершения. Этот метод сохраняет максимальное время ожидания клиента на завершение действия в базе знаний.

```cpp
...
// Обеспечиваем максимальное время ожидания завершения действия.
action.InitiateAndWait(100); // миллисекунды
// Этот аргумент имеет значение по умолчанию, равное 5000 миллисекунд.
...
```

<scg src="../images/actions/action_initiated_with_waiting.gwf"></scg>

!!! предупреждение
    Если вы установите максимальное время ожидания клиента для действия, которое уже имеет максимальное время ожидания клиента, тогда этот метод выдаст `utils::ExceptionInvalidState`.

#### **GetMaxCustomerWaitingTimeLink**

Вы можете получить sc-ссылку с указанием времени, в течение которого клиент будет ждать завершения действия. Если у действия нет времени ожидания, то будет возвращен пустой sc-адрес.
```cpp
...
ScAddr const & waitingTimeAddr = action.GetMaxCustomerWaitingTimeLink();
...
```

#### **GetMaxCustomerWaitingTime**

Вы можете получить время, в течение которого клиент будет ждать завершения действия. Если у действия нет времени ожидания, будет возвращено 0.

```cpp
...
sc_uint32 const waitingTime = action.GetMaxCustomerWaitingTime();
...
```

#### **Initiate**

Или вы можете начать и не ждать, пока оно закончится.

```cpp
...
action.Initiate();
...
```

<scg src="../images/actions/action_initiated.gwf"></scg>

#### **IsFinished**

Используйте этот метод, чтобы проверить, что указанное действие завершено.

```cpp
...
bool const isActionFinished = action.IsFinished();
...
```

<scg src="../images/actions/is_action_finished.gwf"></scg>

Все завершенные действия должны завершаться с одним из следующих статусов:

* завершился успешно;
* завершился неуспешно;
* завершено с ошибкой.

#### **IsFinishedSuccessfully**

Набор действий, завершившихся успешно, включает действия, которые были успешно выполнены с точки зрения субъекта, который их выполнял, т.е. цель была достигнута, например, решение и результат задачи были получены, конструкция была успешно преобразована и т.д.

```cpp
...
bool const isActionFinishedSuccessfully = action.IsFinishedSuccessfully();
...
```

<scg src="../images/actions/is_action_finished_successfully.gwf"></scg>

#### **FinishSuccessfully**

Вы можете успешно завершить действие, которое ещё не было завершено.

```cpp
...
ScResult const & result = action.FinishSuccessfully();
// Используйте результат, чтобы вернуть результат из программы агента.
...
```

<scg src="../images/actions/action_finished_successfully.gwf"></scg>

!!! предупреждение
    Если вы успешно завершите действие, которое уже имеет результат, этот метод выдаст `utils::ExceptionInvalidState`.

!!! предупреждение
    Если вы успешно завершите действие, которое уже завершено или не инициировано, этот метод выдаст `utils::ExceptionInvalidState`.

#### **IsFinishedUnsuccessfully**

Набор действий, завершившихся неуспешно, включает действия, которые не были успешно завершены с точки зрения субъекта, который их выполнял, по каким-либо причинам. Существует две основные причины, по которым такая ситуация может возникнуть:

* соответствующая задача сформулирована неверно;
* формулировка соответствующей задачи корректна и понятна системе, но решение этой задачи в текущий момент не может быть получено в сроки, удовлетворительные с точки зрения исполнителя.

```cpp
...
bool const isActionFinishedUnsuccessfully = action.IsFinishedUnsuccessfully();
...
```

<scg src="../images/actions/is_action_finished_unsuccessfully.gwf"></scg>

#### **FinishUnsuccessfully**

Вы можете неудачно завершить действие, которое еще не завершено.

```cpp
...
ScResult const & result = action.FinishUnsuccessfully();
// Используйте результат для возврата результата из программы агента.
...
```

<scg src="../images/actions/action_finished_unsuccessfully.gwf"></scg>

!!! предупреждение
    Если вы неудачно завершите действие, которое уже имеет результат, этот метод выдаст `utils::ExceptionInvalidState`.

!!! предупреждение
    Если вы неудачно завершите действие, которое завершено или не инициировано, этот метод выдаст `utils::ExceptionInvalidState`.

#### **IsFinishedWithError**

Набор действий, завершившихся с ошибкой, включает действия, выполнение которых не было успешно завершено с точки зрения субъекта, который их выполнял, из-за какой-либо ошибки, такой как неправильная спецификация этого действия или нарушение целостности sc-памяти каким-либо субъектом.

```cpp
...
bool const isActionFinishedWithError = action.IsFinishedWithError();
...
```

<scg src="../images/actions/is_action_finished_with_error.gwf"></scg>

#### **FinishWithError**

Вы можете завершить действие с ошибкой, которое еще не завершено.

```cpp
...
ScResult const & result = action.FinishWithError();
// Используйте результат для возврата результата из программы агента.
...
```

<scg src="../images/actions/action_finished_with_error.gwf"></scg>

!!! предупреждение
    Если вы завершите действие с ошибкой, результат которой уже есть, этот метод выдаст `utils::ExceptionInvalidState`.

!!! предупреждение
    Если вы завершите действие с ошибкой, которая завершена или не инициирована, этот метод выдаст `utils::ExceptionInvalidState`.

Все эти методы возвращают объект `ScResult`. Вы должны вернуть его в программе агента. Вы не можете вызывать конструктор `ScResult`, чтобы создать новый объект.

--- 

## **Часто Задаваемые Вопросы**

<!-- no toc -->
- [В чем разница между `ScAction` и `ScEvent`?](#в-чем-разница-между-scaction-и-scevent)
- [Что если я хочу установить некоторое ребро в качестве результата действия, а не структуру с этим ребром?](#what-if-i-want-to-set-some-edge-as-action-result-and-not-structure-with-this-edge)

### **В чем разница между `ScAction` и `ScEvent`?**

`ScAction` — это класс, представляющий sc-действие. Sc-действие — это процесс, выполняемый каким-либо объектом для решения определенной проблемы. `ScEvent` представляет sc-событие. Sc-событие — это связь между процессом и его исходной и результирующей ситуацией. Действия генерируются после возникновения некоторого sc-события и действия выполняются агентами. Появление событий в sc-памяти приводит к генерации новых процессов.

### **Что если я хочу установить некоторое ребро в качестве результата действия, а не структуру с этим ребром?**

Вам не разрешено это делать. Результатом действия должна быть атомарная формула (высказывание, ситуация или структура). Результат действия описывает, как было выполнено действие. В будущем результатом может стать неатомарная логическая формула.
